<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.StockNewsDAO">

    <!-- ============================= -->
    <!-- Ï¢ÖÎ™©Î≥Ñ Îâ¥Ïä§ -->
    <!-- ============================= -->
    <select id="getNewsByStock" parameterType="string"
            resultType="com.boot.dto.StockNewsDTO">
        SELECT NEWS_ID, STOCK_CODE, TITLE, CONTENT, URL,
               NEWS_DATE, CREATED_AT, SENTIMENT, SCORE, KEYWORDS, UPDATED_AT
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
        ORDER BY NEWS_DATE DESC
    </select>

    <!-- ============================= -->
    <!-- Í∞êÏÑ± ÏöîÏïΩ -->
    <!-- ============================= -->
    <select id="getSentimentSummary" parameterType="string" resultType="map">
        SELECT
            SUM(CASE WHEN SENTIMENT = 'Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT = 'Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT = 'Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
    </select>

    <!-- ============================= -->
    <!-- Ï¢ÖÎ™©Î≥Ñ Í∞êÏÑ± ÌÜµÍ≥Ñ -->
    <!-- ============================= -->
    <select id="getSentimentSummaryByStock" parameterType="string" resultType="map">
        SELECT
            STOCK_CODE,
            COUNT(*) AS totalNews,
            SUM(CASE WHEN SENTIMENT='Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT='Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT='Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount,
            ROUND(SUM(CASE WHEN SENTIMENT='Í∏çÏ†ï' THEN 1 ELSE 0 END)*100/COUNT(*),2) AS positiveRatio,
            ROUND(SUM(CASE WHEN SENTIMENT='Î∂ÄÏ†ï' THEN 1 ELSE 0 END)*100/COUNT(*),2) AS negativeRatio
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
          AND SENTIMENT IS NOT NULL
        GROUP BY STOCK_CODE
    </select>

    <select id="getSentimentSummaryByStockWithPeriod" resultType="map">
        SELECT
            STOCK_CODE,
            COUNT(*) AS totalNews,
            SUM(CASE WHEN SENTIMENT='Í∏çÏ†ï' THEN 1 ELSE 0 END) AS positiveCount,
            SUM(CASE WHEN SENTIMENT='Î∂ÄÏ†ï' THEN 1 ELSE 0 END) AS negativeCount,
            SUM(CASE WHEN SENTIMENT='Î≥¥ÌÜµ' THEN 1 ELSE 0 END) AS neutralCount,
            ROUND(SUM(CASE WHEN SENTIMENT='Í∏çÏ†ï' THEN 1 ELSE 0 END)*100/COUNT(*),2) AS positiveRatio,
            ROUND(SUM(CASE WHEN SENTIMENT='Î∂ÄÏ†ï' THEN 1 ELSE 0 END)*100/COUNT(*),2) AS negativeRatio
        FROM STOCK_NEWS
        WHERE STOCK_CODE = #{stockCode}
          AND SENTIMENT IS NOT NULL
          AND NEWS_DATE >= SYSDATE - #{days}
        GROUP BY STOCK_CODE
    </select>

    <!-- ============================= -->
    <!-- üî• ÎåÄÏãúÎ≥¥Îìú ÌïµÏã¨ (STOCK_NAME Ìè¨Ìï®) -->
    <!-- ============================= -->
    <select id="getAllStockSentimentSummary" resultType="map">
        SELECT
            sn.STOCK_CODE,
            si.STOCK_NAME,
            COUNT(*) AS totalNews,
            ROUND(SUM(CASE WHEN sn.SENTIMENT='Í∏çÏ†ï' THEN 1 ELSE 0 END)*100/COUNT(*),2) AS positiveRatio,
            ROUND(SUM(CASE WHEN sn.SENTIMENT='Î∂ÄÏ†ï' THEN 1 ELSE 0 END)*100/COUNT(*),2) AS negativeRatio
        FROM STOCK_NEWS sn
        LEFT JOIN STOCK_INFO si ON sn.STOCK_CODE = si.STOCK_CODE
        WHERE sn.SENTIMENT IS NOT NULL
        GROUP BY sn.STOCK_CODE, si.STOCK_NAME
        ORDER BY totalNews DESC
    </select>

    <select id="getAllStockSentimentSummaryWithPeriod" resultType="map">
        SELECT
            sn.STOCK_CODE,
            si.STOCK_NAME,
            COUNT(*) AS totalNews,
            ROUND(SUM(CASE WHEN sn.SENTIMENT='Í∏çÏ†ï' THEN 1 ELSE 0 END)*100/COUNT(*),2) AS positiveRatio,
            ROUND(SUM(CASE WHEN sn.SENTIMENT='Î∂ÄÏ†ï' THEN 1 ELSE 0 END)*100/COUNT(*),2) AS negativeRatio
        FROM STOCK_NEWS sn
        LEFT JOIN STOCK_INFO si ON sn.STOCK_CODE = si.STOCK_CODE
        WHERE sn.SENTIMENT IS NOT NULL
          AND sn.NEWS_DATE >= SYSDATE - TO_NUMBER(#{days})
        GROUP BY sn.STOCK_CODE, si.STOCK_NAME
        ORDER BY totalNews DESC
    </select>

    <!-- ============================= -->
    <!-- üî• Top10 (HomePage ÎßàÌÄ¥Ïö©) -->
    <!-- ============================= -->
    <select id="getTop10PopularStocks" resultType="map">
        <![CDATA[
        SELECT *
        FROM (
            SELECT
                n.STOCK_CODE,
                i.STOCK_NAME,
                COUNT(*) AS ARTICLE_COUNT
            FROM STOCK_NEWS n
            JOIN STOCK_INFO i ON n.STOCK_CODE = i.STOCK_CODE
            GROUP BY n.STOCK_CODE, i.STOCK_NAME
            ORDER BY COUNT(*) DESC
        )
        WHERE ROWNUM <= 10
        ]]>
    </select>

    <!-- ============================= -->
    <!-- ÌåÄÏõê Í∏∞Îä• (ÏÇ∞ÏóÖ / ÌÇ§ÏõåÎìú) -->
    <!-- ============================= -->
    <select id="getIndustries" resultType="string">
        SELECT DISTINCT INDUSTRY
        FROM STOCK_INDUSTRY
        ORDER BY INDUSTRY
    </select>

    <select id="getNewsByIndustry" resultType="com.boot.dto.StockNewsDTO">
        SELECT n.*
        FROM STOCK_NEWS n
        JOIN STOCK_INDUSTRY i ON n.STOCK_CODE = i.STOCK_CODE
        WHERE i.INDUSTRY = #{industry}
        ORDER BY n.NEWS_DATE DESC
    </select>

    <select id="getNewsByKeyword" resultType="com.boot.dto.StockNewsDTO">
        SELECT *
        FROM STOCK_NEWS
        WHERE KEYWORDS IS NOT NULL
          AND UPPER(KEYWORDS) LIKE '%' || UPPER(#{keyword}) || '%'
        ORDER BY NEWS_DATE DESC
    </select>

    <select id="getStocksByKeyword" resultType="map">
        SELECT
            s.STOCK_CODE,
            s.STOCK_NAME,
            COUNT(n.NEWS_ID) AS newsCount
        FROM STOCK_INFO s
        JOIN STOCK_NEWS n ON s.STOCK_CODE = n.STOCK_CODE
        WHERE n.KEYWORDS IS NOT NULL
          AND UPPER(n.KEYWORDS) LIKE '%' || UPPER(#{keyword}) || '%'
        GROUP BY s.STOCK_CODE, s.STOCK_NAME
        ORDER BY newsCount DESC
    </select>

</mapper>
