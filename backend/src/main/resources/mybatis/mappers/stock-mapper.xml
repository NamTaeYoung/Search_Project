<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.StockDAO">

    <!-- 1. 주식 정보 매핑 (StockInfoDTO 사용) -->
    <resultMap id="StockMap" type="com.boot.dto.StockInfoDTO">
        <result property="stockCode" column="STOCK_CODE"/>
        <result property="stockName" column="STOCK_NAME"/>
        <result property="marketType" column="MARKET_TYPE"/>
        <result property="industry" column="INDUSTRY"/>
        <result property="price" column="PRICE"/>
        <result property="priceChange" column="PRICE_CHANGE"/>
        <result property="changeRate" column="CHANGE_RATE"/>
        <result property="marketCap" column="MARKET_CAP"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- 2. 뉴스 정보 매핑 (StockNewsDTO 사용) -->
    <resultMap id="NewsMap" type="com.boot.dto.StockNewsDTO">
        <result property="newsId" column="NEWS_ID"/>
        <result property="stockCode" column="STOCK_CODE"/>
        <result property="title" column="TITLE"/>
        <result property="content" column="CONTENT"/>
        <result property="url" column="URL"/>
        <result property="newsDate" column="NEWS_DATE"/>
        <result property="sentiment" column="SENTIMENT"/>
        <result property="score" column="SCORE"/>
        <result property="keywords" column="KEYWORDS"/>
        <result property="createdAt" column="CREATED_AT"/>
    </resultMap>


    <!-- ========================================== -->
    <!--                조회 쿼리                   -->
    <!-- ========================================== -->

    <select id="getStockByCode" resultMap="StockMap">
        SELECT * FROM STOCK_INFO WHERE STOCK_CODE = #{stockCode}
    </select>

    <select id="getNewsByStockCode" resultMap="NewsMap">
        SELECT *
        FROM (
            SELECT * FROM STOCK_NEWS 
            WHERE STOCK_CODE = #{stockCode}
            ORDER BY NEWS_DATE DESC
        )
        WHERE ROWNUM &lt;= 20
    </select>

    <select id="getStocksByIndustry" resultMap="StockMap">
        SELECT *
        FROM STOCK_INFO
        WHERE INDUSTRY = #{industry}
        ORDER BY TO_NUMBER(REGEXP_REPLACE(MARKET_CAP, '[^0-9]', '')) DESC
    </select>

    <select id="getNewsByKeyword" resultMap="NewsMap">
        SELECT *
        FROM (
            SELECT *
            FROM STOCK_NEWS
            WHERE TITLE LIKE '%' || #{keyword} || '%'
               OR CONTENT LIKE '%' || #{keyword} || '%'
            ORDER BY NEWS_DATE DESC
        )
        WHERE ROWNUM &lt;= 10
    </select>


    <!-- ========================================== -->
    <!--                수집 쿼리                   -->
    <!-- ========================================== -->

    <update id="insertStockInfo" parameterType="com.boot.dto.StockInfoDTO">
        MERGE INTO STOCK_INFO T
        USING (
            SELECT 
                #{stockCode, jdbcType=VARCHAR} AS STOCK_CODE,
                #{stockName, jdbcType=VARCHAR} AS STOCK_NAME,
                #{marketType, jdbcType=VARCHAR} AS MARKET_TYPE,
                #{industry, jdbcType=VARCHAR} AS INDUSTRY,
                #{price, jdbcType=INTEGER} AS PRICE,
                #{priceChange, jdbcType=INTEGER} AS PRICE_CHANGE,
                #{changeRate, jdbcType=DOUBLE} AS CHANGE_RATE,
                #{marketCap, jdbcType=VARCHAR} AS MARKET_CAP
            FROM dual
        ) S
        ON (T.STOCK_CODE = S.STOCK_CODE)
        WHEN MATCHED THEN
            UPDATE SET
                T.STOCK_NAME = S.STOCK_NAME,
                T.PRICE = S.PRICE,
                T.CHANGE_RATE = S.CHANGE_RATE,
                T.UPDATED_AT = SYSDATE
        WHEN NOT MATCHED THEN
            INSERT (STOCK_CODE, STOCK_NAME, MARKET_TYPE, INDUSTRY, PRICE, PRICE_CHANGE, CHANGE_RATE, MARKET_CAP, UPDATED_AT)
            VALUES (S.STOCK_CODE, S.STOCK_NAME, S.MARKET_TYPE, S.INDUSTRY, S.PRICE, S.PRICE_CHANGE, S.CHANGE_RATE, S.MARKET_CAP, SYSDATE)
    </update>

    <insert id="insertStockNews" parameterType="com.boot.dto.StockNewsDTO">
        INSERT INTO STOCK_NEWS (
            NEWS_ID, STOCK_CODE, TITLE, CONTENT, URL, 
            NEWS_DATE, SENTIMENT, SCORE, KEYWORDS, CREATED_AT, UPDATED_AT
        ) VALUES (
            STOCK_NEWS_SEQ.NEXTVAL,
            #{stockCode, jdbcType=VARCHAR},
            #{title, jdbcType=VARCHAR},
            #{content, jdbcType=CLOB},
            #{url, jdbcType=VARCHAR},
            #{newsDate, jdbcType=TIMESTAMP},
            #{sentiment, jdbcType=VARCHAR},
            #{score, jdbcType=INTEGER},
            #{keywords, jdbcType=VARCHAR},
            SYSDATE,
            SYSDATE
        )
    </insert>

</mapper>