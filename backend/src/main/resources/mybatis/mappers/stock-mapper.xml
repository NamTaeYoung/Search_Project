<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.boot.dao.StockDAO">

    <!-- 1. ì£¼ì‹ ì •ë³´ ë§¤í•‘ (StockInfoDTO ì‚¬ìš©) -->
    <resultMap id="StockMap" type="com.boot.dto.StockInfoDTO">
        <result property="stockCode" column="STOCK_CODE"/>
        <result property="stockName" column="STOCK_NAME"/>
        <result property="marketType" column="MARKET_TYPE"/>
        <result property="industry" column="INDUSTRY"/>
        <result property="price" column="PRICE"/>
        <result property="priceChange" column="PRICE_CHANGE"/>
        <result property="changeRate" column="CHANGE_RATE"/>
        <result property="marketCap" column="MARKET_CAP"/>
        <result property="updatedAt" column="UPDATED_AT"/>
    </resultMap>

    <!-- 2. ë‰´ìŠ¤ ì •ë³´ ë§¤í•‘ (StockNewsDTO ì‚¬ìš©) -->
    <resultMap id="NewsMap" type="com.boot.dto.StockNewsDTO">
        <result property="newsId" column="NEWS_ID"/>
        <result property="stockCode" column="STOCK_CODE"/>
        <result property="title" column="TITLE"/>
        <result property="content" column="CONTENT"/>
        <result property="url" column="URL"/>
        <result property="newsDate" column="NEWS_DATE"/>
        <result property="sentiment" column="SENTIMENT"/>
        <result property="score" column="SCORE"/>
        <result property="keywords" column="KEYWORDS"/>
        <result property="createdAt" column="CREATED_AT"/>
    </resultMap>


    <!-- ========================================== -->
    <!--                ì¡°íšŒ ì¿¼ë¦¬                   -->
    <!-- ========================================== -->

    <select id="getStockByCode" resultMap="StockMap">
        SELECT * FROM STOCK_INFO WHERE STOCK_CODE = #{stockCode}
    </select>

    <select id="getNewsByStockCode" resultMap="NewsMap">
        SELECT *
        FROM (
            SELECT * FROM STOCK_NEWS 
            WHERE STOCK_CODE = #{stockCode}
            ORDER BY NEWS_DATE DESC
        )
        WHERE ROWNUM &lt;= 20
    </select>

<!-- 3. ì—…ì¢…ë³„ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ (ETF ì²˜ë¦¬ ì¶”ê°€ë¨) -->
    <select id="getStocksByIndustry" resultMap="StockMap">
        SELECT *
        FROM STOCK_INFO
        <where>
            <choose>
                <!-- 1. ìš”ì²­ë°›ì€ íŒŒë¼ë¯¸í„°ê°€ 'ETF' (ë˜ëŠ” ë¬¸ìžì—´ 'null') ì´ë©´ -> NULLì¸ ë°ì´í„° ì¡°íšŒ -->
                <when test="industry == 'ETF' or industry == 'null'">
                    INDUSTRY IS NULL
                </when>
                
                <!-- 2. ê·¸ ì™¸ì—ëŠ” -> í•´ë‹¹ ì—…ì¢…ëª…ê³¼ ì¼ì¹˜í•˜ëŠ” ë°ì´í„° ì¡°íšŒ -->
                <otherwise>
                    INDUSTRY = #{industry}
                </otherwise>
            </choose>
        </where>
        <!-- ì‹œê°€ì´ì•¡ ìˆ«ìž ë³€í™˜ í›„ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ -->
        ORDER BY TO_NUMBER(REGEXP_REPLACE(MARKET_CAP, '[^0-9]', '')) DESC
    </select>


    <!-- ðŸŒŸ [í•µì‹¬ ìˆ˜ì •] ì—…ì¢…ëª…ìœ¼ë¡œ ë‰´ìŠ¤ ì°¾ê¸° (CLOB ì—ëŸ¬ í•´ê²° + ì •í™•ë„ í–¥ìƒ) -->
    <!-- DISTINCTë¥¼ ì œê±°í•˜ê³  ë‹¨ìˆœ JOINìœ¼ë¡œ í•´ë‹¹ ì—…ì¢… ì¢…ëª©ë“¤ì˜ ë‰´ìŠ¤ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤ -->
    <select id="getNewsByKeyword" resultMap="NewsMap">
        SELECT *
        FROM (
            SELECT N.*
            FROM STOCK_NEWS N
            JOIN STOCK_INFO S ON N.STOCK_CODE = S.STOCK_CODE
            <where>
                <choose>
                    <!-- ETFì¸ ê²½ìš° -->
                    <when test="keyword == 'ETF' or keyword == 'null'">
                        S.INDUSTRY IS NULL
                    </when>
                    <!-- ì¼ë°˜ ì—…ì¢…ì¸ ê²½ìš° -->
                    <otherwise>
                        S.INDUSTRY = #{keyword}
                    </otherwise>
                </choose>
            </where>
            ORDER BY N.NEWS_DATE DESC
        )
        WHERE ROWNUM &lt;= 20
    </select>


    <!-- ========================================== -->
    <!--                ìˆ˜ì§‘ ì¿¼ë¦¬                   -->
    <!-- ========================================== -->

    <update id="insertStockInfo" parameterType="com.boot.dto.StockInfoDTO">
        MERGE INTO STOCK_INFO T
        USING (
            SELECT 
                #{stockCode, jdbcType=VARCHAR} AS STOCK_CODE,
                #{stockName, jdbcType=VARCHAR} AS STOCK_NAME,
                #{marketType, jdbcType=VARCHAR} AS MARKET_TYPE,
                #{industry, jdbcType=VARCHAR} AS INDUSTRY,
                #{price, jdbcType=INTEGER} AS PRICE,
                #{priceChange, jdbcType=INTEGER} AS PRICE_CHANGE,
                #{changeRate, jdbcType=DOUBLE} AS CHANGE_RATE,
                #{marketCap, jdbcType=VARCHAR} AS MARKET_CAP
            FROM dual
        ) S
        ON (T.STOCK_CODE = S.STOCK_CODE)
        WHEN MATCHED THEN
            UPDATE SET
                T.STOCK_NAME = S.STOCK_NAME,
                T.PRICE = S.PRICE,
                T.CHANGE_RATE = S.CHANGE_RATE,
                T.UPDATED_AT = SYSDATE
        WHEN NOT MATCHED THEN
            INSERT (STOCK_CODE, STOCK_NAME, MARKET_TYPE, INDUSTRY, PRICE, PRICE_CHANGE, CHANGE_RATE, MARKET_CAP, UPDATED_AT)
            VALUES (S.STOCK_CODE, S.STOCK_NAME, S.MARKET_TYPE, S.INDUSTRY, S.PRICE, S.PRICE_CHANGE, S.CHANGE_RATE, S.MARKET_CAP, SYSDATE)
    </update>

    <insert id="insertStockNews" parameterType="com.boot.dto.StockNewsDTO">
        INSERT INTO STOCK_NEWS (
            NEWS_ID, STOCK_CODE, TITLE, CONTENT, URL, 
            NEWS_DATE, SENTIMENT, SCORE, KEYWORDS, CREATED_AT, UPDATED_AT
        ) VALUES (
            STOCK_NEWS_SEQ.NEXTVAL,
            #{stockCode, jdbcType=VARCHAR},
            #{title, jdbcType=VARCHAR},
            #{content, jdbcType=CLOB},
            #{url, jdbcType=VARCHAR},
            #{newsDate, jdbcType=TIMESTAMP},
            #{sentiment, jdbcType=VARCHAR},
            #{score, jdbcType=INTEGER},
            #{keywords, jdbcType=VARCHAR},
            SYSDATE,
            SYSDATE
        )
    </insert>

</mapper>